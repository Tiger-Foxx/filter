# FoxEngine (C++ Runtime)

**Type :** Moteur de Filtrage R√©seau Haute Performance (Research PoC)  
**Langage :** C++20 (Strict Zero-Copy)  
**Architecture :** Hybride L3/L4 (Radix Trie) + L7 (Hyperscan Streaming)  
**Statut :** üü¢ Pr√™t pour Benchmark

---

## 1. Description Scientifique

Le **FoxEngine** est l'impl√©mentation "Runtime" du projet de recherche sur l'optimisation des r√®gles de filtrage. Contrairement aux IDS classiques (Snort, Suricata) qui r√©√©valuent les r√®gles s√©quentiellement ou par groupes g√©n√©riques, FoxEngine est un ex√©cutant "muet" con√ßu pour interpr√©ter les structures math√©matiques pr√©-calcul√©es par l'optimiseur Python (`tiger-foxx-ids-rules-optimizer`).

### Objectifs de Performance
* **Complexit√© Algorithmique :** $O(1)$ ou $O(\log N)$ pour la d√©cision de filtrage, quel que soit le nombre de r√®gles.
* **Zero-Copy Networking :** Analyse des paquets directement dans le buffer m√©moire du Kernel (via `libnetfilter_queue` mode `COPY_PACKET` mapp√©), sans allocation `std::string` ni copie interm√©diaire.
* **Instruction Pipeline :** Utilisation intensive des instructions vectorielles (AVX2/AVX512) via Hyperscan pour le pattern matching.

---

## 2. Architecture Technique

Le moteur fonctionne selon un pipeline strict √† 3 √©tages pour minimiser le co√ªt CPU par paquet.

### Niveau 0 : Kernel Offload (Bash/Iptables)
* **M√©canisme :** Script `firewall.sh` g√©n√©r√©.
* **R√¥le :** √âlimination imm√©diate des IP/Ports "bruit de fond" directement dans le noyau Linux. Les paquets ne montent jamais en Userspace.

### Niveau 1 : FastPath (C++ L3/L4)
* **Structure :** Radix Trie (Arbre pr√©fixe) optimis√© en m√©moire.
* **Fonctionnement :**
    1.  Lookup IP Source/Destination ($O(32)$ constant).
    2.  V√©rification Bitmap/Intervalle des Ports ($O(1)$).
    3.  **D√©cision :** Si aucune inspection profonde n'est requise (`hs_id == 0`), le verdict (ACCEPT/DROP) est rendu imm√©diatement (Latence < 5¬µs).

### Niveau 2 : DeepPath (C++ L7 Stateful)
* **Structure :** R√©assemblage TCP + Intel Hyperscan.
* **Fonctionnement :**
    1.  Suivi de connexion (5-tuple Flow Tracking).
    2.  R√©ordonnancement des segments TCP (gestion des paquets *Out-of-Order*).
    3.  Scan de contenu via automates finis d√©terministes (DFA) stream√©s.

---

## 3. Pr√©-requis

Le moteur est con√ßu pour **Linux (x86_64)**.

### D√©pendances Syst√®me
```bash
# Debian/Ubuntu
sudo apt update
sudo apt install -y \
    build-essential cmake \
    libnetfilter-queue-dev \
    libnfnetlink-dev \
    libmnl-dev \
    libhyperscan-dev \
    libmsgpack-dev \
    pkg-config
````

### Artefacts (Donn√©es)

Le moteur ne d√©marre pas "√† vide". Il a imp√©rativement besoin des fichiers g√©n√©r√©s par l'optimiseur Python, qui doivent √™tre plac√©s dans le dossier `data/` √† la racine de l'ex√©cutable :

1.  `data/firewall.sh`
2.  `data/patterns.txt`
3.  `data/rules_config.msgpack`

-----

## 4\. Compilation

Le projet utilise CMake. La compilation est configur√©e pour optimiser agressivement (`-O3 -march=native`).

```bash
mkdir build
cd build
cmake ..
make -j$(nproc)
```

L'ex√©cutable binaire `fox-engine` sera g√©n√©r√© dans `build/` (ou `bin/` selon configuration).

-----

## 5\. Usage

### D√©marrage

Le moteur doit √™tre ex√©cut√© avec les privil√®ges **root** pour pouvoir s'accrocher aux queues Netfilter du noyau.

```bash
# Depuis la racine du projet (pour trouver le dossier data/)
sudo ./build/fox-engine
```

Si tout fonctionne, vous verrez :

```text
[INFO] Loading Hyperscan patterns...
[INFO] Parsed X optimized rules.
[INFO] Initializing NFQUEUE interface on Queue ID 0...
[INFO] >>> Engine Running. Waiting for packets...
```

### Interception du Trafic

Par d√©faut, le moteur √©coute sur la **Queue ID 0**. Vous devez rediriger le trafic que vous souhaitez inspecter vers cette queue via `iptables`.

**Exemple : Inspecter tout le trafic entrant (Attention : risque de coupure SSH si bug)**

```bash
sudo iptables -I INPUT -j NFQUEUE --queue-num 0
```

**Exemple s√©curis√© (Test local)**

```bash
# Inspecter seulement le trafic ICMP (Ping)
sudo iptables -I INPUT -p icmp -j NFQUEUE --queue-num 0
```

-----

## 6\. Structure du Code

```text
src/
‚îú‚îÄ‚îÄ main.cpp                  # Point d'entr√©e & Boucle principale
‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îú‚îÄ‚îÄ engine.hpp            # Orchestrateur (Singleton)
‚îÇ   ‚îú‚îÄ‚îÄ packet.hpp            # Parsing Zero-Copy (IP/TCP/UDP headers)
‚îÇ   ‚îî‚îÄ‚îÄ types.hpp             # Structures de donn√©es (DTOs MessagePack)
‚îú‚îÄ‚îÄ fastpath/
‚îÇ   ‚îú‚îÄ‚îÄ ip_radix.hpp          # Impl√©mentation Radix Trie
‚îÇ   ‚îî‚îÄ‚îÄ port_map.hpp          # Logique de matching de ports
‚îú‚îÄ‚îÄ deep/
‚îÇ   ‚îú‚îÄ‚îÄ hs_matcher.hpp        # Wrapper Intel Hyperscan
‚îÇ   ‚îú‚îÄ‚îÄ tcp_stream.hpp        # Logique de flux (Sequencing/Reassembly)
‚îÇ   ‚îî‚îÄ‚îÄ tcp_reassembler.hpp   # Gestionnaire de sessions TCP
‚îî‚îÄ‚îÄ io/
    ‚îú‚îÄ‚îÄ loader.hpp            # Chargement msgpack & patterns
    ‚îî‚îÄ‚îÄ nfqueue.hpp           # Interface Linux Netfilter
```

-----

## 7\. Limitations (PoC Scope)

  * **IPv4 Only :** Le Radix Trie actuel ne g√®re pas l'IPv6.
  * **Mono-thread :** Le moteur traite les paquets s√©quentiellement (suffisant pour la d√©monstration de latence unitaire, mais limitant pour le d√©bit \> 10 Gbps).
  * **TCP Window :** La fen√™tre de r√©assemblage est fixe (limite m√©moire hardcod√©e pour √©viter les DoS).

-----

**Auteur :** FoxEngine Team (Research Lab)  
**Licence :** MIT / Academic Research Use Only